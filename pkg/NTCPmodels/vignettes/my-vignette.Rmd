---
title: "Normal Tissue Complication Probability models:The NTCPmodels package"
author: "Chamberlain Mbah"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{NTCPmodels}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
# Introduction  <a name="introduction"></a>
`NTCPmodels` is a package that fits normal tissue complication probability (NTCP models). The authors of the NTCP package are Chamberlain Mbah and Joris Meys, Joris Meys maintains the R package.  This vignette describes the usage of the NTCPmodels package in R, and refreshes some concepts about NTCP models as we go.

##Installation
The simplest way to install `NTCPmodels` is by using the command
```{r Installation,message=FALSE}
#remotes::install_github("CenterForStatistics-UGent/NTCPmodels/pkg/NTCPmodels@devel")
```

##Brief overview of NTCP models
NTCP models will adequately estimate an organ's complication probability after being irradiated with a given dose if the dose were uniformly distribution (homogeneous) throughout the organ receiving the dose. This is the most critical assumption of NTCP models. However, the total dose that an irradiated organ receives is heterogeneous, this led to the advent of dose volume histograms, to capture some of the dose heterogeneity of organs. Figure: 1 describes how data eventually gets into an NTCP model from a 3-D CT scans through the DVH. 

```{r Flowdiagram_DVH, echo=FALSE,fig.width=7, fig.height=5, warning=FALSE,message=FALSE,fig.cap="Figure: 1 Flow-diagram showing the progress of data from 3-D CT (Computed tomography) scans to dose volume distributions (DVH). DVH data is reduced via means of a reduction scheme to an equivalence uniform dose (EUD) that is normalized to an equivalent dose at 'x' Grays, usually 'x=2'. The NTCP (normal tissue complication probability)  model uses the EUD  for the estimation of parameters."}
#library(diagram)
diagram::openplotmat(main = "")
elpos <- diagram::coordinates (c(1, 1,1,1,1), mx = 0, my = 0)
#elpos[,2]<-seq(1,0,length.out = 5)
diagram::straightarrow(from = elpos[1, ], to = elpos[2, ], lty = 1, lcol = 1,arr.pos = 0.6)
diagram::straightarrow(from = elpos[2, ], to = elpos[3, ], lty = 1, lcol = 1,arr.pos = 0.6)
diagram::straightarrow(from = elpos[3, ], to = elpos[4, ], lty = 1, lcol = 1,arr.pos = 0.6)

diagram::bentarrow(from = elpos[4, ], to = elpos[5, ],lty=1,lcol=1)

labels<-c("(1) 3-D CT scans",
          "(2) DVH", 
          "(3) DVH reduction schemes (EUD,BEUD)",
          "(4) Correction for fractionation (EQDx)",
          "(5) Fitting NTCP models")
 cex<-0.7
 diagram::textrect (elpos[1, ], 0.15, 0.05, lab = labels[1], cex = cex)
 diagram::textrect (elpos[2, ], 0.1, 0.05, lab = labels[2], cex = cex)
 diagram::textrect (elpos[3, ], 0.2, 0.05, lab = labels[3], cex =cex)
 diagram::textrect (elpos[4, ], 0.2, 0.05, lab = labels[4], cex = cex)
 diagram::textrect (elpos[5, ], 0.2, 0.05, lab = labels[5], cex = cex)
```

In Figure:1 the treatment planning systems exports the DVH (Dose Volume Histograms) from 3-D scans. Reduction schemes like, e.g., the equivalent uniform dose (EUD) of Kutcher and Burman or the biological EUD (BEUD) transforms the DVH into a single dose. The equivalence dose at two Grays (EQD2) for example, corrects for fractionation differences between patients to a standard value of two Grays. The NTCP model estimates parameters of interest based on the resulting EUD reduced and  EQD2 transformed DVH data.    

## Nature of input data 
The input DVH data must be in the form of an `R list object`, whose entries are `dataframes`. Each `dataframe` should correspond to a patient and must have two columns. The first column must be the dose bins and the second column the  corresponding volumes. See example below from  in-built DVH data of the first two elements in the list. 

```{r DVH nature,message=FALSE}
library(NTCPmodels)
str(DVH[1:2])
```
If EQD2 transformation is neccesary, then make sure you have the fractionations of all the patients stored in a vector. For the inbuit data,  fractionation is store in the `fractionation` object, see below.
```{r fractionation,message=FALSE}
str(fractionation)

```
The toxicity data should be a vector of 0 (no toxicity) and 1 (toxicity) for all the patients. See below
```{r}
str(toxicity)
```

##Other related  NTCP R packages
`NTCPmodels` package only focuses on fitting NTCP models. However, the `RadOnc` package found  on CRAN, can read DICOM files directly into R and can extract DVH data from the DICOM files. Alternatively, `RadOnc`  also reads  dose volume histogram information from multiple treatment planning system platforms -- consult the vignette of `RadOnc` for details.  Another handy R package that facilitates DVH visualisation and some basic analysis is the `DVHmetrics` package, which can also be found on CRAN. `DVHmetrics` can  read DVH data from multilple treatment planing systems like `RadOnc`. In addition, `DVHmetric` can compute the EUD, EQD2 and NTCP, based on known parameter values.

Both `RadOnc` and `DVHmetric` do not estimate parameters in the NTCP model,  they, never the less, can calculate NTCP and other DVH metrics such as EQD2 and the EUD based on parameters given by the user. The `NTCPmodels`  package is different in the sense that it actually estimates parameters in the  NTCP model. This means a dataset  with DVH  from a set patients go into the NTCP model and are used to estimate the model parameters. With the  estimated parameters , it is possible  to compute an  estimate of the NTCP, the EUD and EQD2, which all contain parameters that are estimable from the  NTCP model. 

#Fitting an NTCP model
